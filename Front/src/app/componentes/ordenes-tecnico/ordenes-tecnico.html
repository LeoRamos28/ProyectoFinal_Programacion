<div *ngIf="mensaje" class="alert alert-success text-center my-3">
  {{ mensaje }}
</div>

<div class="container my-5">
    <div class="card p-4 shadow-lg border-0">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h4 m-0 text-primary">Mis √ìrdenes de Trabajo Asignadas üöÄ</h2>
            </div>

        <div *ngIf="errorMessage" class="alert alert-danger mb-4">
            Error al cargar √≥rdenes: {{ errorMessage }}
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="bg-light">
                    <tr>
                        <th>ID Orden</th>
                        <th>Cliente</th>
                        <th>Direcci√≥n</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let orden of ordenes">
                        <td>{{ orden.id_orden }}</td>
                        <td>{{ orden.cliente_nombre }} {{ orden.cliente_apellido }}</td>
                        <td>{{ orden.direccion_trabajo }}</td>
                        <td>{{ orden.tipo | uppercase }}</td>
                        <td>
                            <span class="badge" 
                                  [class.bg-warning]="orden.estado === 'asignada'" 
                                  [class.bg-primary]="orden.estado === 'en_proceso'"
                                  [class.bg-success]="orden.estado === 'completada'">
                                {{ obtenerNombreEstado(orden.estado) }} 
                            </span>
                        </td>
                        <td>
                            <button *ngIf="orden.estado === 'asignada'" 
                                    (click)="cambiarEstado(orden.id_orden, 'en_proceso')" 
                                    class="btn btn-sm btn-primary me-2">
                                Iniciar
                            </button>

                            <ng-container *ngIf="orden.estado === 'en_proceso'">
                                <button (click)="abrirModalFinalizar(orden)" 
                                        class="btn btn-sm btn-success me-2">
                                    Completar
                                </button>
                                <button (click)="cambiarEstado(orden.id_orden, 'cancelada')" 
                                        class="btn btn-sm btn-danger">
                                    Cancelar
                                </button>
                            </ng-container>

                            <span *ngIf="orden.estado === 'completada' || orden.estado === 'cancelada'" class="text-muted">Finalizada</span>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <div *ngIf="ordenes.length === 0" class="alert alert-info text-center mt-3 border-0 shadow-sm">
                No tienes √≥rdenes de trabajo asignadas o pendientes en este momento. ‚úÖ
            </div>
        </div>
    </div>

    <!-- MODAL DE FINALIZACI√ìN -->
    <div *ngIf="mostrarModal && ordenSeleccionada" class="modal-overlay">
        <!-- Agregamos scroll por si la lista de materiales es larga -->
        <div class="card p-5 shadow-2xl modal-content-centered" style="max-height: 90vh; overflow-y: auto;">
            <h3 class="mb-4 text-center text-success">Reporte de Orden #{{ ordenSeleccionada.id_orden }}</h3>
            
            <form (ngSubmit)="confirmarFinalizar()">
                <div class="mb-3">
                    <label class="form-label">Soluci√≥n o Trabajo Realizado (*):</label>
                    <textarea 
                        class="form-control" 
                        rows="4" 
                        [(ngModel)]="solucion_reclamo" 
                        name="solucion_reclamo" 
                        required>
                    </textarea>
                </div>
                
                <!-- ================= NUEVA SECCI√ìN: INSUMOS UTILIZADOS ================= -->
                <hr class="my-4">
                <h5 class="text-secondary mb-3">üõ†Ô∏è Insumos Utilizados (Opcional)</h5>

                <!-- FILA DE SELECCI√ìN DE MATERIALES -->
                <div class="row g-2 align-items-end mb-3 bg-light p-2 rounded border">
                    <div class="col-md-6">
                        <label class="small text-muted">Material</label>
                        <select class="form-select form-select-sm" [(ngModel)]="idProductoSeleccionado" name="selProd">
                            <option [ngValue]="null">Seleccionar...</option>
                            <!-- Itera sobre el inventario cargado -->
                            <option *ngFor="let item of listaInventario" [value]="item.id_producto">
                                {{ item.nombre }} (Stock: {{ item.stock_actual }})
                            </option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted">Cant.</label>
                        <input type="number" class="form-control form-control-sm" [(ngModel)]="cantidadInput" name="selCant" min="0.1" step="0.1">
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-sm btn-outline-primary w-100" (click)="agregarMaterial()">
                            + Agregar
                        </button>
                    </div>
                </div>

                <!-- LISTA DEL "CARRITO" DE MATERIALES -->
                <div *ngIf="materialesUsados.length > 0" class="table-responsive mb-3 border rounded">
                    <table class="table table-sm table-striped mb-0 small">
                        <thead class="table-dark">
                            <tr>
                                <th>Material</th>
                                <th class="text-center">Cant.</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let m of materialesUsados; let i = index">
                                <td>{{ m.nombre }}</td>
                                <td class="text-center fw-bold">{{ m.cantidad_usada }}</td>
                                <td class="text-end">
                                    <button type="button" class="btn btn-link text-danger p-0 text-decoration-none" (click)="eliminarMaterial(i)">
                                        ‚ùå
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- ================= FIN SECCI√ìN INSUMOS ================= -->
                
                
                <div *ngIf="solucion_reclamo.length < 5" class="text-danger small mt-1">
                    La descripci√≥n de la soluci√≥n es obligatoria al completar la orden.
                </div>

                <div class="mt-4 text-end">
                    <button type="button" (click)="cerrarModal()" class="btn btn-secondary me-2">Cancelar</button>
                    <button type="submit" 
                            class="btn btn-success"
                            [disabled]="solucion_reclamo.length < 5">
                        Completar Orden
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>