<div class="container-fluid px-2 px-md-4 my-4">
  <div class="card shadow-sm border-0">
    <div class="card-body p-3 p-md-4">
      <div *ngIf="mensaje" class="alert alert-success text-center mb-4 shadow-sm">
        {{ mensaje }}
      </div>

      <div
        class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3"
      >
        <div class="d-flex gap-2 w-100 w-md-auto">
          <button
            (click)="mostrarFormularioCliente = true"
            class="btn btn-success btn-sm rounded-pill px-3 flex-fill shadow-sm fw-bold py-2"
          >
            <i class="bi bi-person-plus-fill"></i>
            <span class="d-none d-sm-inline">Nuevo Cliente</span
            ><span class="d-sm-none">+ Cliente</span>
          </button>
          <button
            (click)="abrirFormularioOrden()"
            class="btn btn-primary btn-sm rounded-pill px-3 flex-fill shadow-sm fw-bold py-2"
            [disabled]="clientes.length === 0"
          >
            <i class="bi bi-file-earmark-plus"></i>
            <span class="d-none d-sm-inline">Nueva Orden</span
            ><span class="d-sm-none">+ Orden</span>
          </button>
        </div>
      </div>

      <div *ngIf="errorMessage" class="alert alert-danger text-center">
        {{ errorMessage }}
      </div>

      <div class="d-flex align-items-center mb-3">
        <h3 class="h6 mb-0 fw-bold">Mis Órdenes Creadas</h3>
        <span class="badge bg-light text-dark ms-2 border">{{ misOrdenes.length }}</span>
      </div>

      <div class="table-responsive rounded-3 border">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th class="ps-3">ID</th>
              <th>Cliente</th>
              <th class="d-none d-md-table-cell text-center">Tipo</th>
              <th class="d-none d-lg-table-cell">Técnico</th>
              <th class="text-center">Estado</th>
              <th class="text-end pe-3 d-none d-sm-table-cell">Fecha</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let orden of misOrdenes">
              <td class="ps-3 fw-bold text-muted small">#{{ orden.id_orden }}</td>
              <td>
                <div class="fw-bold">{{ orden.cliente_nombre }}</div>
                <div class="d-md-none small text-muted text-uppercase" style="font-size: 0.7rem">
                  {{ orden.tipo }}
                </div>
              </td>
              <td class="d-none d-md-table-cell text-center">
                <span
                  class="badge badge-medium"
                  [class.badge-instalacion]="orden.tipo === 'instalacion'"
                  [class.badge-reclamo]="orden.tipo === 'reclamo'"
                >
                  {{ orden.tipo | titlecase }}
                </span>
              </td>
              <td class="d-none d-lg-table-cell text-muted small">
                {{ orden.tecnico_nombre || 'Sin asignar' }}
              </td>
              <td class="text-center">
                <span
                  class="badge badge-status"
                  [class.card-pendiente]="orden.estado === 'pendiente'"
                  [class.card-asignada]="orden.estado === 'asignada'"
                  [class.card-finalizada]="orden.estado === 'finalizada'"
                  [class.card-en-proceso]="orden.estado === 'en_proceso'"
                  [class.card-cancelada]="orden.estado === 'cancelada'"
                >
                  {{ orden.estado | titlecase }}
                </span>
              </td>
              <td class="text-end pe-3 text-muted small d-none d-sm-table-cell">
                {{ orden.fecha_creacion | date: 'dd/MM/yy' }}
              </td>
            </tr>
          </tbody>
        </table>
        <div *ngIf="misOrdenes.length === 0" class="p-5 text-center text-muted">
          <i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>
          No has creado ninguna orden aún.
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="mostrarFormularioCliente" class="modal-overlay px-2">
  <div class="card shadow-2xl modal-content-centered border-0 overflow-hidden">
    <div class="bg-dark p-3 text-white text-center">
      <h3 class="h5 mb-0 fw-bold">Registrar Nuevo Cliente</h3>
    </div>
    <div class="p-3 p-md-4 scroll-container">
      <form (ngSubmit)="guardarCliente()">
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label small fw-bold">Nombre</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="nuevoCliente.nombre"
              name="cnombre"
              required
            />
          </div>
          <div class="col-6">
            <label class="form-label small fw-bold">Apellido</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="nuevoCliente.apellido"
              name="capellido"
              required
            />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label small fw-bold">DNI</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="nuevoCliente.dni"
              name="cdni"
              required
            />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small fw-bold">Provincia</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="nuevoCliente.provincia"
              name="cprovincia"
              required
            />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small fw-bold">Localidad</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="nuevoCliente.localidad"
              name="clocalidad"
              required
            />
          </div>
          <div class="col-12">
            <label class="form-label small fw-bold">Dirección Completa</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="nuevoCliente.direccion"
              name="cdireccion"
              required
            />
          </div>
        </div>
        <div class="mt-4 d-flex gap-2">
          <button
            type="button"
            (click)="mostrarFormularioCliente = false"
            class="btn btn-danger border flex-fill fw-bold"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-success flex-fill fw-bold shadow-sm">
            Guardar Cliente
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div *ngIf="mostrarFormularioOrden" class="modal-overlay px-2">
  <div class="card shadow-2xl modal-content-centered border-0 overflow-hidden">
    <div class="bg-dark p-3 text-white text-center">
      <h3 class="h5 mb-0 fw-bold">Crear Orden de Trabajo</h3>
    </div>
    <div class="p-3 p-md-4 scroll-container">
      <form (ngSubmit)="guardarOrden()">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label small fw-bold">Cliente Asociado</label>
            <select
              class="form-select"
              [(ngModel)]="nuevaOrden.id_cliente"
              name="oidCliente"
              required
              (ngModelChange)="onClienteSeleccionado($event)"
            >
              <option [value]="0" disabled>Seleccione un cliente...</option>
              <option *ngFor="let c of clientes" [ngValue]="c.id_cliente">
                {{ c.nombre }} {{ c.apellido }}
              </option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label small fw-bold">Tipo de Servicio</label>
            <select class="form-select" [(ngModel)]="nuevaOrden.tipo" name="oTipo" required>
              <option value="instalacion">Instalación</option>
              <option value="reclamo">Reclamo / Reparación</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label small fw-bold">Dirección del Trabajo</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="nuevaOrden.direccion_trabajo"
              name="oDireccion"
              required
            />
          </div>
          <div class="col-12">
            <label class="form-label small fw-bold">Descripción del problema</label>
            <textarea
              class="form-control"
              [(ngModel)]="nuevaOrden.descripcion"
              name="oDescripcion"
              rows="2"
              required
            ></textarea>
          </div>
          <div class="col-12">
            <label class="form-label small fw-bold">Asignar Técnico</label>
            <select
              class="form-select"
              [(ngModel)]="nuevaOrden.id_tecnico_asignado"
              name="oTecnico"
            >
              <option [ngValue]="null">Dejar Pendiente</option>
              <option
                *ngFor="let t of tecnicos"
                [ngValue]="t.id_usuario"
                [disabled]="(t.ordenes_pendientes ?? 0) >= MAX_ORDENES_PENDIENTES"
              >
                {{ t.nombre }} {{ t.apellido }} (Carga: {{ t.ordenes_pendientes ?? 0 }}/{{
                  MAX_ORDENES_PENDIENTES
                }})
              </option>
            </select>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label small fw-bold">Fecha de Visita</label>
            <input
              type="date"
              class="form-control"
              [(ngModel)]="nuevaOrden.fecha_asignacion"
              name="oFechaAsignacion"
            />
          </div>
        </div>
        <div class="mt-4 d-flex gap-2">
          <button
            type="button"
            (click)="mostrarFormularioOrden = false"
            class="btn btn-danger border flex-fill fw-bold"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-success flex-fill fw-bold shadow-sm">
            Crear Orden
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
