<div *ngIf="mensaje" class="alert alert-success text-center my-3 mx-2">
  {{ mensaje }}
</div>

<div
  class="notification-icon me-3 position-relative p-2"
  (click)="mostrarAlertas = !mostrarAlertas"
  style="cursor: pointer; z-index: 1000"
>
  <i class="fa fa-bell fs-4 text-warning"></i>
  <span
    *ngIf="alertas.length > 0"
    class="badge bg-danger position-absolute top-0 start-100 translate-middle badge-pill border border-light rounded-pill"
  >
    {{ alertas.length }}
  </span>
</div>

<div class="container-fluid mt-3 mt-md-4">
  <div
    class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3"
  >
    <button class="btn btn-primary fw-bold w-100 w-md-auto" (click)="nuevoProducto()">
      <i class="fa fa-plus"></i> + Nuevo Material
    </button>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th class="d-none d-md-table-cell">ID</th>
              <th>Material</th>
              <th class="d-none d-lg-table-cell">Descripci√≥n</th>
              <th class="text-center">Stock</th>
              <th class="d-none d-sm-table-cell">Unidad</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="cargando">
              <td colspan="6" class="text-center py-4">Cargando...</td>
            </tr>
            <tr *ngFor="let item of listaProductos">
              <td class="d-none d-md-table-cell text-muted">#{{ item.id_producto }}</td>
              <td>
                <div class="fw-bold text-wrap" style="max-width: 150px">{{ item.nombre }}</div>
                <div class="d-sm-none x-small text-muted">{{ item.unidad_medida }}</div>
              </td>
              <td class="d-none d-lg-table-cell text-muted small">{{ item.descripcion }}</td>
              <td class="text-center">
                <span
                  class="badge rounded-pill px-3 py-2"
                  [ngClass]="item.stock_actual <= item.stock_minimo ? 'bg-danger' : 'bg-success'"
                >
                  {{ item.stock_actual }}
                </span>
              </td>
              <td class="d-none d-sm-table-cell">{{ item.unidad_medida }}</td>
              <td class="text-end text-nowrap">
                <button class="btn btn-sm btn-light border me-1" (click)="editarProducto(item)">
                  ‚úèÔ∏è
                </button>
                <button
                  class="btn btn-sm btn-light border text-danger"
                  (click)="eliminar(item.id_producto)"
                >
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div *ngIf="mostrarAlertas" class="container-fluid mt-3">
  <div class="row justify-content-center">
    <div class="col-12 col-md-6 col-lg-4">
      <div
        *ngFor="let alerta of alertas"
        class="alert alert-warning alert-dismissible fade show mb-2 shadow-sm border-0"
        role="alert"
      >
        <div class="d-flex align-items-left">
          <i class="fa fa-exclamation-triangle me-2 mt-1"></i>
          <div class="small text-wrap">
            {{ obtenerTextoAlerta(alerta) }}
            <div class="opacity-75 mt-1">{{ alerta.fecha_alerta | date: 'short' }}</div>
          </div>
          <button
            type="button"
            class="btn-close"
            (click)="resolverAlerta(alerta.id_alerta); $event.stopPropagation()"
          ></button>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="mostrarModal" class=" modal-overlay px-2">
  <div class="card p-3 p-md-4 shadow-lg modal-content-centered border-0">
    <h3 class="mb-3 text-center fs-4 fw-bold text-dark">
      {{ productoActual.id_producto ? 'Editar Material' : 'Nuevo Material' }}
    </h3>

    <form (ngSubmit)="guardar()" #form="ngForm">
      <div class="mb-3">
        <label class="form-label small fw-bold">Nombre del Material (*)</label>
        <input
          type="text"
          class="form-control"
          [(ngModel)]="productoActual.nombre"
          name="nombre"
          required
        />
      </div>

      <div class="mb-3">
        <label class="form-label small fw-bold">Descripci√≥n</label>
        <textarea
          class="form-control"
          rows="2"
          [(ngModel)]="productoActual.descripcion"
          name="descripcion"
        ></textarea>
      </div>

      <div class="row g-2">
        <div class="col-6 mb-3">
          <label class="form-label small fw-bold">Stock Actual</label>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="productoActual.stock_actual"
            name="stock"
          />
        </div>
        <div class="col-6 mb-3">
          <label class="form-label small fw-bold">Stock M√≠nimo</label>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="productoActual.stock_minimo"
            name="stock_minimo"
          />
        </div>
        <div class="col-12 mb-3">
          <label class="form-label small fw-bold">Unidad de Medida</label>
          <select class="form-select" [(ngModel)]="productoActual.unidad_medida" name="unidad">
            <option value="Unidades">Unidades</option>
            <option value="Metros">Metros</option>
            <option value="Cajas">Cajas</option>
            <option value="Bobinas">Bobinas</option>
          </select>
        </div>
      </div>

      <div class="mt-4 d-flex gap-2">
        <button type="button" (click)="cerrarModal()" class="btn btn-danger border w-100 fw-bold">
          Cancelar
        </button>
        <button type="submit" class="btn btn-success w-100 fw-bold">
          {{ productoActual.id_producto ? 'Actualizar' : 'Guardar' }}
        </button>
      </div>
    </form>
  </div>
</div>
